# --- 基础信息 / Basic Information ---
local app_id="cripoxyapi"  # 注意：原为 CLIProxyAPI，此处已按您的代码调整为 cripoxyapi
local app_name="CLIProxyAPI"
local app_text="将 Gemini、Claude、Codex、Qwen 等免费模型包装成 OpenAI 兼容 API 服务"
local app_url="https://github.com/router-for-me/CLIProxyAPI"
local docker_name="cli-proxy-api"
local docker_port="8317"
local app_size="1"

# --- 核心逻辑 / Core Logic ---
docker_app_install() {
    # 必须在 /home/docker/ 下创建应用目录
    mkdir -p /home/docker/CLIProxyAPI && cd /home/docker/CLIProxyAPI

    # 下载仓库（推荐使用 gh_proxy 加速国内访问）
    git clone "${gh_proxy}github.com/router-for-me/CLIProxyAPI.git" . || {
        echo "克隆仓库失败，请检查网络或 gh_proxy 设置"
        return 1
    }

    # 准备配置文件（必须）
    cp config.example.yaml config.yaml
    cp .env.example .env

    # 直接打开 nano 编辑 config.yaml（核心修改点）
    echo "即将打开 config.yaml 进行编辑。请完成以下关键配置："
    echo "  - api-keys: 添加至少一个密钥，例如："
    echo "      api-keys:"
    echo "        - \"sk-your-secret-key-123\""
    echo "  - 根据需求启用 provider（如 gemini、claude、qwen 等）"
    echo "  - 可选：调整模型映射、负载均衡、remote-management 等"
    echo ""
    echo "编辑完成后：按 Ctrl+O 保存 → Enter 确认 → Ctrl+X 退出"
    echo "按 Enter 键开始编辑..."
    read -r

    nano config.yaml

    # 编辑完成后确认是否继续（可选，可移除）
    echo "config.yaml 编辑完成。按 Enter 继续安装..."
    read -r

    # 端口处理（使用变量，便于用户自定义）
    sed -i "s/8317:8317/${docker_port}:8317/g" docker-compose.yml 2>/dev/null || true

    # 启动服务（使用官方预构建镜像，推荐）
    docker compose up -d

    echo "安装完成。服务运行在端口 ${docker_port}"
    echo "首次使用需完成模型授权（OAuth 登录），请参考下方说明。"

    # 显示访问地址（假设函数已定义）
    check_docker_app_ip

    # 授权提示（重要步骤，仅需执行一次）
    echo ""
    echo "=== 模型授权步骤（必须）==="
    echo "1. 执行以下命令进入容器并触发登录流程："
    echo "   docker compose exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -no-browser"
    echo "   （或针对特定模型：-claude-login、-codex-login 等，运行 -help 查看）"
    echo "2. 复制输出的链接到浏览器完成 Google/Anthropic 等登录"
    echo "3. 授权成功后 token 会自动持久化到卷中，无需重复操作"
    echo "=============================="
}

docker_app_update() {
    cd /home/docker/CLIProxyAPI || { echo "目录不存在"; return 1; }
    git pull  # 可选：拉取最新 compose 和配置文件示例
    docker compose pull
    docker compose up -d
    echo "更新完成"
}

docker_app_uninstall() {
    cd /home/docker/CLIProxyAPI || { echo "目录不存在"; return 1; }
    # 停止并删除容器、网络、卷（--volumes 可选，如果想彻底清除 token）
    docker compose down --rmi all --volumes
    # 彻底物理删除目录
    cd .. && rm -rf CLIProxyAPI
    echo "卸载完成"
}

# --- 注册 (必须包含) / Registration (Mandatory) ---
docker_app_plus
