# --- 基础信息 / Basic Information ---
local app_id="CLIProxyAPI"  # 注意：原为 CLIProxyAPI，此处已按您的代码调整为 cripoxyapi
local app_name="CLIProxyAPI"
local app_text="将 Gemini、Claude、Codex、Qwen 等免费模型包装成 OpenAI 兼容 API 服务"
local app_url="https://github.com/router-for-me/CLIProxyAPI"
local docker_name="cli-proxy-api"
local docker_port="8317"
local app_size="1"

# --- 核心逻辑 / Core Logic ---
docker_app_install() {
    # 必须在 /home/docker/ 下创建应用目录
    mkdir -p /home/docker/CLIProxyAPI && cd /home/docker/CLIProxyAPI

    # 下载仓库（推荐使用 gh_proxy 加速国内访问）
    git clone "${gh_proxy}github.com/router-for-me/CLIProxyAPI.git" . || {
        echo "克隆仓库失败，请检查网络或 gh_proxy 设置"
        return 1
    }

    # 准备配置文件（必须）
    cp config.example.yaml config.yaml
    cp .env.example .env

    # 直接打开 nano 编辑 config.yaml（核心修改点）
    echo "即将打开 config.yaml 进行编辑。请完成以下关键配置："
    echo "  - api-keys: 添加至少一个密钥，例如："
    echo "      api-keys:"
    echo "        - \"sk-your-secret-key-123\""
    echo "  - 根据需求启用 provider（如 gemini、claude、qwen 等）"
    echo "  - 可选：调整模型映射、负载均衡、remote-management 等"
    echo ""
    echo "编辑完成后：按 Ctrl+O 保存 → Enter 确认 → Ctrl+X 退出"
    echo "按 Enter 键开始编辑..."
    read -r

    nano config.yaml

    # 编辑完成后确认是否继续（可选，可移除）
    echo "config.yaml 编辑完成。按 Enter 继续安装..."
    read -r

    # 端口处理（使用变量，便于用户自定义）
    sed -i "s/8317:8317/${docker_port}:8317/g" docker-compose.yml 2>/dev/null || true

    # 启动服务（使用官方预构建镜像，推荐）
    docker compose up -d

    echo "安装完成。服务运行在端口 ${docker_port}"
    echo "首次使用需完成模型授权（OAuth 登录），请参考下方说明。"

    # 显示访问地址（假设函数已定义）
    check_docker_app_ip

    # 授权提示（重要步骤，仅需执行一次）
    echo ""
    echo "=== 模型授权步骤（必须）==="
    echo "CLIProxyAPI 支持多种免费模型的 OAuth 授权。请根据您希望启用的模型，选择对应的命令执行。"
    echo ""
    echo "针对特定模型的专用授权命令："
    echo "  Gemini（Google）："
    echo "    docker exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -no-browser --login"
    echo "  OpenAI Codex："
    echo "    docker exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -no-browser --codex-login"
    echo "  Claude（Anthropic）："
    echo "    docker exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -no-browser --claude-login"
    echo "  Qwen（阿里通义千问）："
    echo "    docker exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -no-browser --qwen-login"
    echo "  iFlow："
    echo "    docker exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -no-browser --iflow-login"
    echo "  Antigravity："
    echo "    docker exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -no-browser --antigravity-login"
    echo ""
    echo "执行步骤："
    echo "1. 选择并运行上述任一命令（建议从 Gemini 开始）。"
    echo "2. 命令会输出授权链接（https://...）及 SSH 隧道命令。"
    echo "3. 在您的本地电脑（非服务器）执行生成的 SSH 隧道命令（例如：ssh -L 8085:127.0.0.1:8085 root@您的IP -p 22）。"
    echo "4. 保持隧道窗口打开，在本地浏览器访问生成的授权链接，完成登录并授权。"
    echo "5. 授权成功后，服务器终端会显示确认信息，token 自动保存至持久化卷。"
    echo "6. 后续模型授权可重复此流程，无需重复操作已授权的模型。"
    echo ""
    echo "查看所有支持的登录标志："
    echo "  docker compose exec ${docker_name} /CLIProxyAPI/CLIProxyAPI -help"
    echo "=============================="
}

docker_app_update() {
    cd /home/docker/CLIProxyAPI || { echo "目录不存在"; return 1; }
    git pull  # 可选：拉取最新 compose 和配置文件示例
    docker compose pull
    docker compose up -d
    echo "更新完成"
}

docker_app_uninstall() {
    cd /home/docker/CLIProxyAPI || { echo "目录不存在"; return 1; }
    # 停止并删除容器、网络、卷（--volumes 可选，如果想彻底清除 token）
    docker compose down --rmi all --volumes
    # 彻底物理删除目录
    cd .. && rm -rf CLIProxyAPI
    echo "卸载完成"
}

# --- 注册 (必须包含) / Registration (Mandatory) ---
docker_app_plus
