# --- 基础信息 / Basic Information ---
local app_id="zitadel"
local app_name="ZITADEL"
local app_text="开源云原生身份管理平台 (IdP)，支持 SSO、MFA 和多租户"
local app_url="https://zitadel.com"
local docker_name="zitadel"
local docker_port="8205"
local app_size="2"

# --- 核心逻辑 / Core Logic ---
docker_app_install() {
    local base_dir="/home/docker/zitadel"
    mkdir -p "$base_dir" && cd "$base_dir"

    # 1. 下载官方 Compose 文件
    echo "正在获取部署配置..."
    curl -L https://raw.githubusercontent.com/zitadel/zitadel/main/docs/docs/self-hosting/deploy/docker-compose.yaml -o docker-compose.yml

    # 2. 端口处理 (替换默认的 8080)
    sed -i "s/8080:8080/${docker_port}:8080/g" docker-compose.yml

    # 3. 启动 (ZITADEL 需要 setup 过程，官方 compose 已包含)
    echo "正在拉取镜像并启动 ZITADEL (首次启动较慢)..."
    docker compose pull
    docker compose up -d --wait

    echo "------------------------------------------------"
    echo "安装完成 / Install Complete"
    echo "访问地址: http://服务器IP:${docker_port}/ui/console"
    echo "默认账号: zitadel-admin@zitadel.localhost"
    echo "默认密码: Password1!"
    echo "注意: 生产环境请务必修改 Master Key 和管理密码"
    echo "------------------------------------------------"

    check_docker_app_ip
}

docker_app_update() {
    cd /home/docker/zitadel
    docker compose pull
    docker compose up -d
    echo "更新完成 / Update Complete"
}

docker_app_uninstall() {
    cd /home/docker/zitadel
    docker compose down --volumes --rmi all
    rm -rf /home/docker/zitadel
    echo "卸载完成 / Uninstall Complete"
}

# --- 注册 / Registration ---
docker_app_plus
